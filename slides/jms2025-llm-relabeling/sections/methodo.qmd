## M√©thodologie { .smaller}

- üéØ [**Objectif**]{.orange} : Reconstruire un jeu d'entra√Ænement le plus exhaustif possible
- üí°[**Principe**]{.orange} : consid√©rer les LLMs comme des [**annotateurs virtuels**]{.blue2} 

![](../img/methodo-nace-rev.png){fig-align="center"}

::: notes
- Utilisation de [**LLMs**]{.orange} pour g√©n√©rer des annotations en NAF 2025
- [**Donn√©es**]{.orange} √† disposition : 
  1. Stock [**Sirene 4**]{.blue2} ($~2.7$ millions d'observations)
  2. [**Table de passage**]{.blue2} r√©alis√©e par les experts APE
  3. [**Notes explicatives**]{.blue2} de la NAF 2025
  4. [**Annotations manuelles**]{.blue2} ($~30k$ observations)
:::

::: notes
Le principe est de reconstruire la base la plus compl√®te possible.
En reproduisant le travail des experts par le LLM et en choisissant le LLM qui s'aligne au mieux avec les annotations manuelles
de la campagne
On s√©pare les univoques qui sont recod√©s par une table, des multivoques qui sont recod√©s par LLM.
Cela nous a permis d'avoir une base d'apprentissage suffisamment volumineuse pour entra√Æner notre classifieur
S'il faut retenir une chose, c'est qu'on labellise virtuellement les multivoques par LLM
:::

## Le prompting {.scrollable}

- Prompt [**syst√®me**]{.orange} identique pour toutes les observations

  <details> 
  <summary> 
      <font size=3 color=black><b>Afficher le prompt syt√®me</b></font> 
  </summary>

  ```
  Tu es un expert de la Nomenclature statistique des Activit√©s √©conomiques dans la Communaut√© Europ√©enne (NACE). Tu es charg√© de r√©aliser le changement de nomenclature. Ta mission consiste √† attribuer un code NACE 2025 √† une entreprise, en t'appuyant sur le descriptif de son activit√© et √† partir d'une liste de codes propos√©s (identifi√©e √† partir de son code NACE 2008 existant). Voici les instructions √† suivre :
  1. Analyse la description de l'activit√© principale de l'entreprise et le code NACE 2008 fourni par l'utilisateur.
  2. √Ä partir de la liste des codes NACE 2025 disponible, identifie la cat√©gorie la plus appropri√©e qui correspond √† l'activit√© principale de l'entreprise.
  3. Retourne le code NACE 2025 au format JSON comme sp√©cifi√© par l'utilisateur. Si la description de l'activit√© de l'entreprise n'est pas suffisamment pr√©cise pour identifier un code NACE 2025 ad√©quat, retourne `null` dans le JSON.
  4. √âvalue la coh√©rence entre le code NACE 2008 fourni et la description de l'activit√© de l'entreprise. Si le code NACE 2008 ne semble pas correspondre √† cette description, retourne `False` dans le champ `nace08_valid` du JSON. Note que si tu arrives √† classer la description de l'activit√© de l'entreprise dans un code NACE 2025, le champ `nace08_valid` devrait `True`, sinon il y a incoh√©rence.
  5. R√©ponds seulement avec le JSON compl√©t√© aucune autres information ne doit √™tre retourn√©.
  ```

  </details>

- Un prompt [**sp√©cifique**]{.orange} pour chaque observation comprenant : 
  - le [**libell√©**]{.blue2} de l'activit√© principale de l'entreprise
  - l'ancien [**code NAF 2008**]{.blue2} connu
  - La [**liste des codes possibles**]{.blue2} issues du mapping avec leurs [**notes explicatives**]{.blue2}

- Une [**instruction sur le format**]{.orange} de r√©ponse attendu

<details> 
<summary> 
    <font size=3 color=black><b>Afficher un exemple de r√©ponse attendue</b></font> 
</summary>

```json
{
    "codable": true,
    "nace_2008_valid": true,
    "nace2025": "0147J" 
}
```

</details>



::: notes
Pour guider le LLM il faut le prompter
2 types: pour lui donner sa feuille de route global, un prompt g√©n√©rique appel√© prompt syst√®me
dans lequel on lui donne un r√¥le et les diff√©rentes √©tapes √† effectuer tel un annotateur virtuel.

Un prompt sp√©cifique, la requ√™te o√π on lui donne les infos n√©cessaire pour coder.
Un LLM peut √™tre assez verbeux ou volubile, donc important de qualifier sa r√©ponse 
:::


## Importance du contexte

![](../img/hallucination.drawio.png){fig-align="center"}

::: notes
Sans ou avec peu de contexte, un LLM peut difficilement coder en NAF 2025
en tout cas aujourd'hui ...
Il peut ce qu'on appelle halluciner cad fournir r√©ponses incorrectes, invent√©es ou inexactes
:::

##  Illustration avec ChatGPT

### R√©ponse format√©e

![](../img/hallucination_chatgpt_NAF_2025.png){fig-align="center"}

::: notes
En donnant le prompt syst√®me sans le prompt sp√©cifique qui apporte le contexte,
le LLM ne conna√Æt pas la NAF 2025 et donne le bon code certes mais en NAF rev 2, ce qui est faux
:::

##  Illustration avec ChatGPT

### R√©ponse non format√©e

![](../img/demande_contexte_chatgpt_NAF_2025.png){fig-align="center"}

::: notes
Sans demander de formater la r√©ponse, il comprend qu'il y a besoin de consulter la NAF 2025 
mais il a fallu une it√©ration suppl√©mentaire, ce qui est co√ªteux dans le contexte d'inf√©rence par batch.
:::

## Injection du contexte

![](../img/cag_application_naf.png){fig-align="center"}*

::: notes
C'est pour cela que l'on ajoute du contexte.
Il existe diff√©rentes techniques dont la plus populaire est le RAG.
mais c'est bien ce contexte que l'on retrouve dans notre requ√™te.
La quantit√© de texte que le LLM peut examiner est appel√© fen√™tre de contexte.
:::